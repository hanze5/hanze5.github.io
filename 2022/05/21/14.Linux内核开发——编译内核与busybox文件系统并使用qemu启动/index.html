<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Linux内核," />










<meta name="description" content="参考链接：https:&#x2F;&#x2F;blog.csdn.net&#x2F;song_lee&#x2F;article&#x2F;details&#x2F;105815237 参考连接：从源码编译linux-4.9内核并运行一个最小的busybox文件系统（最新整理版） - 哔哩哔哩 (bilibili.com) 1.前期准备 实验环境  vmware 16 pro ubuntu 22.04   首先需要确认CPU是支持虚拟化的  &#96;&#96;&#96;shell">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux内核——编译内核与busybox文件系统并使用qemu启动">
<meta property="og:url" content="http://hanze5.github.io/2022/05/21/14.Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8%E4%B8%8Ebusybox%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B9%B6%E4%BD%BF%E7%94%A8qemu%E5%90%AF%E5%8A%A8/index.html">
<meta property="og:site_name" content="也许不会有人进来吧">
<meta property="og:description" content="参考链接：https:&#x2F;&#x2F;blog.csdn.net&#x2F;song_lee&#x2F;article&#x2F;details&#x2F;105815237 参考连接：从源码编译linux-4.9内核并运行一个最小的busybox文件系统（最新整理版） - 哔哩哔哩 (bilibili.com) 1.前期准备 实验环境  vmware 16 pro ubuntu 22.04   首先需要确认CPU是支持虚拟化的  &#96;&#96;&#96;shell">
<meta property="og:locale">
<meta property="og:image" content="http://hanze5.github.io/images/14/1677997900172.png">
<meta property="og:image" content="http://hanze5.github.io/images/14/1678000057028.png">
<meta property="og:image" content="http://hanze5.github.io/images/14/1678000486617.png">
<meta property="og:image" content="http://hanze5.github.io/images/14/1678000467715.png">
<meta property="og:image" content="http://hanze5.github.io/images/14/1678002515221.png">
<meta property="og:image" content="http://hanze5.github.io/images/14/1678005089603.png">
<meta property="og:image" content="http://hanze5.github.io/images/14/1678005190545.png">
<meta property="og:image" content="http://hanze5.github.io/images/14/1678006002978.png">
<meta property="article:published_time" content="2022-05-21T08:49:43.000Z">
<meta property="article:modified_time" content="2023-03-05T09:13:43.461Z">
<meta property="article:author" content="Dawnlake">
<meta property="article:tag" content="Linux内核">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://hanze5.github.io/images/14/1677997900172.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://hanze5.github.io/2022/05/21/14.Linux内核开发——编译内核与busybox文件系统并使用qemu启动/"/>





  <title>Linux内核——编译内核与busybox文件系统并使用qemu启动 | 也许不会有人进来吧</title>
  








<meta name="generator" content="Hexo 6.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">也许不会有人进来吧</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hanze5.github.io/2022/05/21/14.Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8%E4%B8%8Ebusybox%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B9%B6%E4%BD%BF%E7%94%A8qemu%E5%90%AF%E5%8A%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也许不会有人进来吧">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Linux内核——编译内核与busybox文件系统并使用qemu启动</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-05-21T16:49:43+08:00">
                2022-05-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%97%A0%E6%AD%A2%E5%A2%83/" itemprop="url" rel="index">
                    <span itemprop="name">学无止境</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>参考链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/song_lee/article/details/105815237">https://blog.csdn.net/song_lee/article/details/105815237</a></p>
<p>参考连接：<a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv11271232?spm_id_from=333.999.0.0">从源码编译linux-4.9内核并运行一个最小的busybox文件系统（最新整理版） - 哔哩哔哩 (bilibili.com)</a></p>
<h2 id="1-前期准备"><a href="#1-前期准备" class="headerlink" title="1.前期准备"></a>1.前期准备</h2><ul>
<li><p>实验环境</p>
<ul>
<li>vmware 16 pro</li>
<li>ubuntu 22.04</li>
</ul>
</li>
<li><p>首先需要确认CPU是支持虚拟化的</p>
<ul>
<li>```shell<br>dawnlake@dawnlake-virtual-machine:~$ lsmod | grep kvm<br>kvm_intel             434176  0<br>kvm                  1130496  1 kvm_intel<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - vmware可以通过编辑虚拟机设置来开启处理器的虚拟化功能![1677995747801](/images/14/1677995747801.png)</span><br><span class="line"></span><br><span class="line">- 下载配置内核所需要的依赖</span><br><span class="line"></span><br><span class="line">  ```shell</span><br><span class="line">  sudo apt-get install ncurses-dev libncurses-dev flex bison bc</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>安装交叉编译工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install gcc-arm-linux-gnueabi</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里先使用Ubuntu自带的qemu</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install qemu</span><br><span class="line">sudo apt install qemu-system-x86 </span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="2-下载linux内核源码"><a href="#2-下载linux内核源码" class="headerlink" title="2.下载linux内核源码"></a>2.下载linux内核源码</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.edge.kernel.org/pub/linux/kernel/v4.x/linux-4.9.229.tar.xz  </span><br></pre></td></tr></table></figure>
<p>太慢了，直接浏览器下完用vscode往上传的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dawnlake@dawnlake-virtual-machine:~/Downloads$ ls</span><br><span class="line">linux-4.9.229  linux-4.9.229.tar.xz</span><br></pre></td></tr></table></figure>
<p><img src="/images/14/1677997900172.png" alt="1677997900172"></p>
<ul>
<li>arch 目录， 和具体cpu有关的代码，例如arm/mach-omap1，即ti公司的soc，此soc的cpu核是ARM提供</li>
<li>init目录， 内核启动代码。对应到应用层就是main，内核里最早的目录是内核的解压程序，先执行汇编代码让cpu做一些初始化。 初始化完成之后会执行这个目录里的main。</li>
<li>drivers目录，驱动框架代码，例如i2c，dma， leds 鼠标 键盘 反正就是各种驱动。做驱动开发的可以关注一下。</li>
<li>fs目录，文件系统 </li>
<li>kernel目录， 注意和arm/kernel目录的区别。 kernel目录会调用arm/kernel。</li>
<li>net目录， 网络协议</li>
<li>include目录</li>
<li>mm目录 内存相关</li>
</ul>
<h2 id="3-编译内核"><a href="#3-编译内核" class="headerlink" title="3.编译内核"></a>3.编译内核</h2><p>下列命令要在管理员权限下执行，root用户可以不用加sudo</p>
<ol>
<li><p>指定硬件体系架构 ， 因为开发环境是x86，要编译arm内核就需要指定ARCH=arm且需要安装交叉编译器。 前面已经装好。这只是个临时的环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo export ARCH=x86 </span><br></pre></td></tr></table></figure>
</li>
<li><p>配置board config,此处配置为 x86_64_defconfig。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sudo make  x86_64_defconfig </span><br><span class="line"></span><br><span class="line">root@dawnlake-virtual-machine:/home/dawnlake/Downloads/linux-4.9.229# make  x86_64_defconfig </span><br><span class="line">  HOSTCC  scripts/basic/fixdep</span><br><span class="line">  HOSTCC  scripts/kconfig/conf.o</span><br><span class="line">  SHIPPED scripts/kconfig/zconf.tab.c</span><br><span class="line">  SHIPPED scripts/kconfig/zconf.lex.c</span><br><span class="line">  SHIPPED scripts/kconfig/zconf.hash.c</span><br><span class="line">  HOSTCC  scripts/kconfig/zconf.tab.o</span><br><span class="line">  HOSTLD  scripts/kconfig/conf</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># configuration written to .config</span></span></span><br><span class="line"><span class="meta prompt_">#</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置内核，针对性配置，和实验不想关的就不做配置，避免内核臃肿。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure>
<p><img src="/images/14/1678000057028.png" alt="1678000057028"></p>
<p>进来之后，（[*]代表要选中哈）</p>
<ul>
<li>General setup   —-&gt;   <ul>
<li>[*] Initial RAM filesystem and RAM disk (initramfs/initrd) support  </li>
</ul>
</li>
<li>Device Drivers  —-&gt;     <ul>
<li>[*] Block devices  —-&gt;   </li>
<li><img src="/images/14/1678000486617.png" alt="1678000486617"><ul>
<li><img src="/images/14/1678000467715.png" alt="1678000467715"></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>操作时候一看就懂不解释了。</p>
</li>
<li><p>然后执行make编译</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure>
<p>执行完毕后结果显示（找得到的），</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Kernel: arch/x86/boot/bzImage is ready  (#1)</span><br></pre></td></tr></table></figure>
<p>这就是编译好的内核。</p>
</li>
</ol>
<h2 id="4-编译文件系统-busybox"><a href="#4-编译文件系统-busybox" class="headerlink" title="4.编译文件系统 busybox"></a>4.编译文件系统 busybox</h2><h3 id="BusyBox-The-Swiss-Army-Knife-of-Embedded-Linux"><a href="#BusyBox-The-Swiss-Army-Knife-of-Embedded-Linux" class="headerlink" title="BusyBox: The Swiss Army Knife of Embedded Linux"></a>BusyBox: The Swiss Army Knife of Embedded Linux</h3><ul>
<li><p>BusyBox combines tiny versions of many common UNIX utilities into a single small executable. It provides replacements for most of the utilities you usually find in GNU fileutils, shellutils, etc. The utilities in BusyBox generally have fewer options than their full-featured GNU cousins; however, the options that are included provide the expected functionality and behave very much like their GNU counterparts. BusyBox provides a fairly complete environment for any small or embedded system.</p>
</li>
<li><p>BusyBox has been written with size-optimization and limited resources in mind. It is also extremely modular so you can easily include or exclude commands (or features) at compile time. This makes it easy to customize your embedded systems. To create a working system, just add some device nodes in /dev, a few configuration files in /etc, and a Linux kernel.</p>
</li>
</ul>
<ol>
<li><p>下载busybox 地址<a target="_blank" rel="noopener" href="https://busybox.net/downloads/">Index of /downloads (busybox.net)</a> 版本： 1.30.0  并解压 报错  建议下载更新版本的&gt;=1.36.0</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xvf busybox-1.30.0.tar.bz2 </span><br></pre></td></tr></table></figure>
<p>然后进入到目录下</p>
</li>
<li><p>配置buysbox源码 </p>
<p>在这里我们把busybox配置为静态编译，这样busybox在运行的时候就不需要额外的动态链接库了。 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig </span><br><span class="line"></span><br><span class="line">Settings  ---&gt;</span><br><span class="line">      Build Options  ---&gt;</span><br><span class="line">            [*] Build BusyBox as a static binary (no shared libs) </span><br></pre></td></tr></table></figure>
<p>操作时候就能看懂</p>
</li>
<li><p>然后编译安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install </span><br><span class="line">=======================================================================</span><br><span class="line">/usr/bin/ld: libbb/lib.a(inet_common.o): in function `INET6_resolve&#x27;:</span><br><span class="line">inet_common.c:(.text.INET6_resolve+0x4a): warning: Using &#x27;getaddrinfo&#x27; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/usr/bin/ld: coreutils/lib.a(mktemp.o): in function `mktemp_main&#x27;:</span><br><span class="line">mktemp.c:(.text.mktemp_main+0x98): warning: the use of `mktemp&#x27; is dangerous, better use `mkstemp&#x27; or `mkdtemp&#x27;</span><br><span class="line">/usr/bin/ld: networking/lib.a(ipcalc.o): in function `ipcalc_main&#x27;:</span><br><span class="line">ipcalc.c:(.text.ipcalc_main+0x231): warning: Using &#x27;gethostbyaddr&#x27; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/usr/bin/ld: libbb/lib.a(inet_common.o): in function `INET_resolve&#x27;:</span><br><span class="line">inet_common.c:(.text.INET_resolve+0x4d): warning: Using &#x27;gethostbyname&#x27; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/usr/bin/ld: networking/lib.a(inetd.o): in function `reread_config_file&#x27;:</span><br><span class="line">inetd.c:(.text.reread_config_file+0x254): warning: Using &#x27;getservbyname&#x27; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/usr/bin/ld: networking/lib.a(netstat.o): in function `ip_port_str&#x27;:</span><br><span class="line">netstat.c:(.text.ip_port_str+0x50): warning: Using &#x27;getservbyport&#x27; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">/usr/bin/ld: util-linux/lib.a(rdate.o): in function `rdate_main&#x27;:</span><br><span class="line">rdate.c:(.text.rdate_main+0xff): undefined reference to `stime&#x27;</span><br><span class="line">/usr/bin/ld: coreutils/lib.a(date.o): in function `date_main&#x27;:</span><br><span class="line">date.c:(.text.date_main+0x25b): undefined reference to `stime&#x27;</span><br><span class="line">collect2: error: ld returned 1 exit status</span><br><span class="line">Note: if build needs additional libraries, put them in CONFIG_EXTRA_LDLIBS.</span><br><span class="line">Example: CONFIG_EXTRA_LDLIBS=&quot;pthread dl tirpc audit pam&quot;</span><br><span class="line">make: *** [Makefile:718: busybox_unstripped] Error 1</span><br></pre></td></tr></table></figure>
<p>解决方案：换更高版本的busybox</p>
<p>如果是老版本的ubuntu应该是不会报错，如果报错要么降低ubuntu版本，要么升级busybox版本。</p>
<p>重新执行上述步骤，安装成功<img src="/images/14/1678002515221.png" alt="1678002515221"></p>
<p>目前还不是完整的文件系统，还待完善，无法直接使用。现在只是目录，内核识别的是文件系统。内核启动需要consle打印信息，但是这里面连dev都没有，所以也不存在什么设备文件。</p>
</li>
<li><p>进入_install目录，补充一些必要的文件或目录，相关的shell命令如下： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建一下三个目录</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> etc dev mnt</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">虚拟文件系统  虚拟文件系统 临时文件系统</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> -p proc sys tmp</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">里面存放文件系统启动的脚本</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> -p etc/init.d/</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">新建并且存放文件系统挂载信息 文件系统启动时会在这个文件中读取挂载信息 将这些文件系统挂载起来</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">vim etc/fstab</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">文件系统     挂载路径</span></span><br><span class="line">proc        /proc           proc         defaults        0        0</span><br><span class="line">tmpfs       /tmp            tmpfs    　　defaults        0        0</span><br><span class="line">sysfs       /sys            sysfs        defaults        0        0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">busybox启动时执行的代码</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">vim etc/init.d/rcS</span></span><br><span class="line"></span><br><span class="line">echo -e &quot;Welcome to tinyLinux&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Linux mount命令是经常会使用到的命令，它用于挂载Linux系统外的文件。</span></span><br><span class="line">/bin/mount -a    #把上面的该挂载的挂载 </span><br><span class="line">echo -e &quot;Remounting the root filesystem&quot;</span><br><span class="line">mount  -o  remount,rw  /   #把根文件系统重新挂载以此设置成可读可写</span><br><span class="line">mkdir -p /dev/pts          </span><br><span class="line">mount -t devpts devpts /dev/pts  #用来挂载文件系统 -t：指定档案系统的型态，通常不必指定。mount 会自动选择正确的型态。</span><br><span class="line">echo /sbin/mdev &gt; /proc/sys/kernel/hotplug   #用来处理热插拔</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">mdev是busybox提供的一个工具，用在嵌入式系统中，相当于简化版的udev，作用是在系统启动和热插拔或动态加载驱动程序时，</span></span><br><span class="line">mdev -s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> 755 etc/init.d/rcS</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">busybox执行的文件  一般的linux文件系统没有</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">vim etc/inittab</span></span><br><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line">::respawn:-/bin/sh</span><br><span class="line">::askfirst:-/bin/sh</span><br><span class="line">::ctrlaltdel:/bin/umount -a -r</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> 755 etc/inittab</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建设备节点</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> dev</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">c表示字符型设备   5 主设备号 1 次设备号</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mknod</span> console c 5 1</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mknod</span> null c 1 3</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mknod</span> tty1 c 4 1</span> </span><br></pre></td></tr></table></figure>
<p><strong>至此完整的文件系统制作完成</strong></p>
</li>
</ol>
<h2 id="5-制作跟文件系统镜像"><a href="#5-制作跟文件系统镜像" class="headerlink" title="5.制作跟文件系统镜像"></a>5.制作跟文件系统镜像</h2><ol>
<li><p>先制作一个空的镜像文件；</p>
</li>
<li><p>然后把此镜像文件格式化为ext3格式；</p>
</li>
<li><p>然后把此镜像文件挂载，并把根文件系统复制到挂载目录；</p>
</li>
<li><p>卸载该镜像文件。</p>
</li>
<li><p>打成gzip包。 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">rm</span> -rf rootfs.ext3</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">rm</span> -rf fs</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">dd</span>命令 可以创建一个空的镜像文件</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=./rootfs.ext3 bs=1M count=32</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">格式化为ext3的格式</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mkfs.ext3 rootfs.ext3</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将该镜像文件挂载到fs这样一个临时的目录下</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> fs</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mount -o loop rootfs.ext3 ./fs</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">然后把刚才./_install/* 也就是文件系统的东西 拷贝到 fs里 就相当于放到刚才的镜像里边了</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cp</span> -rf ./_install/* ./fs</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">释放挂载点</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">umount ./fs</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">打包成内核能识别的压缩模式</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gzip --best -c rootfs.ext3 &gt; rootfs.img.gz</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>下面是重要的步骤成功时的输出</p>
<p><img src="/images/14/1678005089603.png" alt="1678005089603"></p>
<p><img src="/images/14/1678005190545.png" alt="1678005190545"></p>
</li>
</ol>
<h2 id="6-qemu启动内核与文件系统"><a href="#6-qemu启动内核与文件系统" class="headerlink" title="6.qemu启动内核与文件系统"></a>6.qemu启动内核与文件系统</h2><p>​    参数说明：</p>
<ul>
<li>-kernel 编译好的内核镜像</li>
<li>-initrd 编译好的文件系统镜像</li>
<li>-append  “init” 表示内核在启动之后转交给文件系统执行的第一个程序</li>
<li>-serial输出日志</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">qemu-system-x86_64 \</span></span><br><span class="line"><span class="language-bash">    -kernel ./linux-4.9.229/arch/x86_64/boot/bzImage  \ </span> </span><br><span class="line">    -initrd ./busybox-1.36.0/rootfs.img.gz   \</span><br><span class="line">    -append &quot;root=/dev/ram init=/linuxrc&quot;  \</span><br><span class="line">    -serial file:output.txt </span><br></pre></td></tr></table></figure>
<p><strong><em>注意：要在图形界面下执行！</em></strong>而且执行目录是<code>linux-4.9.229</code>所在的目录。</p>
<p>很快啊！！！！</p>
<p><img src="/images/14/1678006002978.png" alt="1678006002978"></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Linux%E5%86%85%E6%A0%B8/" rel="tag"># Linux内核</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/01/21/11-C-%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94http%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91/" rel="next" title="11.C++实战——Http业务逻辑">
                <i class="fa fa-chevron-left"></i> 11.C++实战——Http业务逻辑
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2023/02/13/%E5%8A%9B%E6%89%A3%E7%BB%8F%E9%AA%8C%E6%95%99%E8%AE%AD/" rel="prev" title="力扣刷题经验教训（持续更新）">
                力扣刷题经验教训（持续更新） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/my_avatar.png"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/">
              
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87"><span class="nav-number">1.</span> <span class="nav-text">1.前期准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%8B%E8%BD%BDlinux%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81"><span class="nav-number">2.</span> <span class="nav-text">2.下载linux内核源码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8"><span class="nav-number">3.</span> <span class="nav-text">3.编译内核</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E7%BC%96%E8%AF%91%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F-busybox"><span class="nav-number">4.</span> <span class="nav-text">4.编译文件系统 busybox</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BusyBox-The-Swiss-Army-Knife-of-Embedded-Linux"><span class="nav-number">4.1.</span> <span class="nav-text">BusyBox: The Swiss Army Knife of Embedded Linux</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E5%88%B6%E4%BD%9C%E8%B7%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F"><span class="nav-number">5.</span> <span class="nav-text">5.制作跟文件系统镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-qemu%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8%E4%B8%8E%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-number">6.</span> <span class="nav-text">6.qemu启动内核与文件系统</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dawnlake</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
