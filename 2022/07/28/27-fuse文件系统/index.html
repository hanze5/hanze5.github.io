<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="随便看看," />










<meta name="description" content="fuse文件系统跟着简叔学的，可以B站搜索 简说linux 1. 基于fuse实现的文件系统用户空间文件系统（Filesystem in Userspace），是Linux 中用于挂载某些网络空间，如SSH，到本地文件系统的模块，在SourceForge上可以找到相关内容。fuse文件系统依赖底层libfuse库来实现。 内核驱动在编写的时候调用内核的一些函数和头文件，编译的时候需要编译到内核空间">
<meta property="og:type" content="article">
<meta property="og:title" content="fuse文件系统">
<meta property="og:url" content="http://hanze5.github.io/2022/07/28/27-fuse%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/index.html">
<meta property="og:site_name" content="也许不会有人进来吧">
<meta property="og:description" content="fuse文件系统跟着简叔学的，可以B站搜索 简说linux 1. 基于fuse实现的文件系统用户空间文件系统（Filesystem in Userspace），是Linux 中用于挂载某些网络空间，如SSH，到本地文件系统的模块，在SourceForge上可以找到相关内容。fuse文件系统依赖底层libfuse库来实现。 内核驱动在编写的时候调用内核的一些函数和头文件，编译的时候需要编译到内核空间">
<meta property="og:locale">
<meta property="og:image" content="http://hanze5.github.io/images/27/1678260671375.png">
<meta property="og:image" content="http://hanze5.github.io/images/27/1678272408329.png">
<meta property="og:image" content="http://hanze5.github.io/images/27/1678261083674.png">
<meta property="og:image" content="http://hanze5.github.io/images/27/1678272204252.png">
<meta property="og:image" content="http://hanze5.github.io/images/27/1678263392378.png">
<meta property="og:image" content="http://hanze5.github.io/images/27/1678264933414.png">
<meta property="og:image" content="http://hanze5.github.io/images/27/1678265272054.png">
<meta property="og:image" content="http://hanze5.github.io/images/27/1678271691547.png">
<meta property="og:image" content="http://hanze5.github.io/images/27/1678271804532.png">
<meta property="article:published_time" content="2022-07-28T11:39:27.000Z">
<meta property="article:modified_time" content="2023-03-08T11:41:54.009Z">
<meta property="article:author" content="Dawnlake">
<meta property="article:tag" content="随便看看">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://hanze5.github.io/images/27/1678260671375.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://hanze5.github.io/2022/07/28/27-fuse文件系统/"/>





  <title>fuse文件系统 | 也许不会有人进来吧</title>
  








<meta name="generator" content="Hexo 6.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">也许不会有人进来吧</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hanze5.github.io/2022/07/28/27-fuse%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也许不会有人进来吧">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">fuse文件系统</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-07-28T19:39:27+08:00">
                2022-07-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%97%A0%E6%AD%A2%E5%A2%83/" itemprop="url" rel="index">
                    <span itemprop="name">学无止境</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="fuse文件系统"><a href="#fuse文件系统" class="headerlink" title="fuse文件系统"></a>fuse文件系统</h1><p>跟着简叔学的，可以B站搜索 <strong>简说linux</strong></p>
<h2 id="1-基于fuse实现的文件系统"><a href="#1-基于fuse实现的文件系统" class="headerlink" title="1. 基于fuse实现的文件系统"></a>1. 基于fuse实现的文件系统</h2><p>用户空间文件系统（Filesystem in Userspace），是Linux 中用于挂载某些<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/网络空间/7650101?fromModule=lemma_inlink">网络空间</a>，如<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/SSH/10407?fromModule=lemma_inlink">SSH</a>，到本地文件系统的模块，在SourceForge上可以找到相关内容。fuse文件系统依赖底层libfuse库来实现。</p>
<p>内核驱动在编写的时候调用内核的一些函数和头文件，编译的时候需要编译到内核空间里边去运行，通过insmod的方式加载到内核空间里边去运行。而用户空间驱动是运行在用户空间的，就像开发普通的应用程序，更加灵活但是有一些底层的功能支持并不完整。比如中断，锁等机制。之所以有用户空间驱动是因为内核驱动的功能比较固定而用户的需求又比较多变。</p>
<p>以SSH服务为例，我们正常可以通过ssh连接远端去访问文件资源，也可以通过fuse文件系统的方式把远端目录挂载到本地的文件目录。</p>
<p><img src="/images/27/1678260671375.png" alt="1678260671375"></p>
<p><img src="/images/27/1678272408329.png" alt="1678272408329"></p>
<p>使用sshfs命令 ，可以将远端的某目录挂载到本地的目录。VFS是Linux文件系统对外的接口。任何要使用文件系统的程序都必须经由这层接口来使用它。如果VFS发现访问的是fuse文件系统，就把请求交给/dev/fuse驱动去处理，主要是做一个中转，最终实现是交由libfuse去实现请求的处理逻辑。</p>
<p><img src="/images/27/1678261083674.png" alt="1678261083674"></p>
<p><img src="/images/27/1678272204252.png" alt="1678272204252"></p>
<h2 id="2-libfuse代码阅读"><a href="#2-libfuse代码阅读" class="headerlink" title="2.libfuse代码阅读"></a>2.libfuse代码阅读</h2><h3 id="2-1试着运行hello这个最简单的文件系统"><a href="#2-1试着运行hello这个最简单的文件系统" class="headerlink" title="2.1试着运行hello这个最简单的文件系统"></a>2.1试着运行hello这个最简单的文件系统</h3><p>所谓的“用户态文件系统”，是指一个文件系统的<strong>data(内容</strong>)和<strong>metadata(描述文件的数据)</strong>都是由用户态的进程提供的（这种进程被称为“<strong>daemon</strong>”）。<strong>data</strong>和<strong>metadata</strong>通过这两个东西才能完整的描述一个文件或者目录。</p>
<p>先下载libfuse库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/libfuse/libfuse.git</span><br><span class="line">cd libfuse</span><br><span class="line">mkdir build; cd build</span><br><span class="line">meson ..</span><br><span class="line">//如果提示没有meson的话</span><br><span class="line">apt install meson</span><br><span class="line">//如果meson提示Did not find pkg-config by name &#x27;pkg-config&#x27;的话</span><br><span class="line">apt-get install pkg-config</span><br><span class="line"></span><br><span class="line">ninja</span><br><span class="line">//如果/usr/bin/python3: No module named pytest</span><br><span class="line">apt install python3-pip</span><br><span class="line">pip3 install pytest -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">python3 -m pytest test/</span><br></pre></td></tr></table></figure>
<p><img src="/images/27/1678263392378.png" alt="1678263392378"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">##如果报错这个问题就需要修改根目录的权限</span><br><span class="line">chmod O+rx ...</span><br></pre></td></tr></table></figure>
<p>问题解决之后继续执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ninja install</span><br></pre></td></tr></table></figure>
<p>注意上述命令都是在build下执行的然后进入到build/example目录下，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./hello + 要挂载文件系统的目录</span><br></pre></td></tr></table></figure>
<h2 id="比如"><a href="#比如" class="headerlink" title="比如"></a>比如<img src="/images/27/1678264933414.png" alt="1678264933414"></h2><p>查看挂载信息</p>
<p><img src="/images/27/1678265272054.png" alt="1678265272054"></p>
<p>之所以有这么多条是因为当时胡乱操作了一通，可以看到类型都是 fuse.hello 正常的文件系统类型都是nsfs什么的，内核里面通过fuse关键字匹配fuse文件系统，进而在匹配我们自定义的hello文件系统。</p>
<h3 id="2-2hello文件系统的实现"><a href="#2-2hello文件系统的实现" class="headerlink" title="2.2hello文件系统的实现"></a>2.2hello文件系统的实现</h3><p>去libfuse/example/hello.c查看</p>
<ol>
<li><p>首先定义了options结构体，然后进行一系列初始化。定义了操作文件的方式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">options</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *filename;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *contents;</span><br><span class="line">	<span class="type">int</span> show_help;</span><br><span class="line">&#125; options;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OPTION(t, p)                           \</span></span><br><span class="line"><span class="meta">    &#123; t, offsetof(struct options, p), 1 &#125;</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fuse_opt</span> <span class="title">option_spec</span>[] =</span> &#123;</span><br><span class="line">	OPTION(<span class="string">&quot;--name=%s&quot;</span>, filename),</span><br><span class="line">	OPTION(<span class="string">&quot;--contents=%s&quot;</span>, contents),</span><br><span class="line">	OPTION(<span class="string">&quot;-h&quot;</span>, show_help),</span><br><span class="line">	OPTION(<span class="string">&quot;--help&quot;</span>, show_help),</span><br><span class="line">	FUSE_OPT_END</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义文件的一系列操作 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">hello_readdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">void</span> *buf, <span class="type">fuse_fill_dir_t</span> filler,</span></span><br><span class="line"><span class="params">			 <span class="type">off_t</span> offset, <span class="keyword">struct</span> fuse_file_info *fi,</span></span><br><span class="line"><span class="params">			 <span class="keyword">enum</span> fuse_readdir_flags flags)</span></span><br><span class="line">&#123;</span><br><span class="line">	(<span class="type">void</span>) offset;</span><br><span class="line">	(<span class="type">void</span>) fi;</span><br><span class="line">	(<span class="type">void</span>) flags;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//如果是根目录就返回错误？</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strcmp</span>(path, <span class="string">&quot;/&quot;</span>) != <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -ENOENT;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//否则就. .. 文件的名字返回回去</span></span><br><span class="line">	filler(buf, <span class="string">&quot;.&quot;</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	filler(buf, <span class="string">&quot;..&quot;</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	filler(buf, options.filename, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/27/1678271691547.png" alt="1678271691547"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">hello_read</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">char</span> *buf, <span class="type">size_t</span> size, <span class="type">off_t</span> offset,</span></span><br><span class="line"><span class="params">		      <span class="keyword">struct</span> fuse_file_info *fi)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">size_t</span> len;</span><br><span class="line">	(<span class="type">void</span>) fi;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">strcmp</span>(path+<span class="number">1</span>, options.filename) != <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -ENOENT;</span><br><span class="line"></span><br><span class="line">	len = <span class="built_in">strlen</span>(options.contents); <span class="comment">//对应的就是helloworld这个字符串的基址</span></span><br><span class="line">	<span class="keyword">if</span> (offset &lt; len) &#123;</span><br><span class="line">		<span class="keyword">if</span> (offset + size &gt; len)</span><br><span class="line">			size = len - offset;</span><br><span class="line">		<span class="built_in">memcpy</span>(buf, options.contents + offset, size);</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/27/1678271804532.png" alt="1678271804532"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">hello_getattr</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="keyword">struct</span> stat *stbuf,</span></span><br><span class="line"><span class="params">			 <span class="keyword">struct</span> fuse_file_info *fi)</span></span><br><span class="line">&#123;</span><br><span class="line">	(<span class="type">void</span>) fi;</span><br><span class="line">	<span class="type">int</span> res = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(stbuf, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> stat));</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strcmp</span>(path, <span class="string">&quot;/&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">		stbuf-&gt;st_mode = S_IFDIR | <span class="number">0755</span>;</span><br><span class="line">		stbuf-&gt;st_nlink = <span class="number">2</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(path+<span class="number">1</span>, options.filename) == <span class="number">0</span>) &#123;</span><br><span class="line">		stbuf-&gt;st_mode = S_IFREG | <span class="number">0444</span>;</span><br><span class="line">		stbuf-&gt;st_nlink = <span class="number">1</span>;</span><br><span class="line">		stbuf-&gt;st_size = <span class="built_in">strlen</span>(options.contents);</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		res = -ENOENT;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>main函数中，最重点的是<code>fuse_main</code>，相当于让我们之前定义的<code>fuse_operations</code>起作用<code>struct fuse_operations</code>可以对应内核文件系统的<code>struct file_operations</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fuse_args</span> <span class="title">args</span> =</span> FUSE_ARGS_INIT(argc, argv);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Set defaults -- we have to use strdup so that</span></span><br><span class="line"><span class="comment">	   fuse_opt_parse can free the defaults if other</span></span><br><span class="line"><span class="comment">	   values are specified */</span></span><br><span class="line">	options.filename = strdup(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">	options.contents = strdup(<span class="string">&quot;Hello World!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Parse options   解析参数 fuse提供的直接用就可 */</span></span><br><span class="line">	<span class="keyword">if</span> (fuse_opt_parse(&amp;args, &amp;options, option_spec, <span class="literal">NULL</span>) == <span class="number">-1</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* When --help is specified, first print our own file-system</span></span><br><span class="line"><span class="comment">	   specific help text, then signal fuse_main to show</span></span><br><span class="line"><span class="comment">	   additional help (by adding `--help` to the options again)</span></span><br><span class="line"><span class="comment">	   without usage: line (by setting argv[0] to the empty</span></span><br><span class="line"><span class="comment">	   string) */</span></span><br><span class="line">	<span class="keyword">if</span> (options.show_help) &#123;</span><br><span class="line">		show_help(argv[<span class="number">0</span>]);</span><br><span class="line">		assert(fuse_opt_add_arg(&amp;args, <span class="string">&quot;--help&quot;</span>) == <span class="number">0</span>);</span><br><span class="line">		args.argv[<span class="number">0</span>][<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    </span><br><span class="line">	ret = fuse_main(args.argc, args.argv, &amp;hello_oper, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">	fuse_opt_free_args(&amp;args);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fuse_operations</span> <span class="title">hello_oper</span> =</span> &#123;</span><br><span class="line">	.init       = hello_init,</span><br><span class="line">	.getattr	= hello_getattr,</span><br><span class="line">	.readdir	= hello_readdir,</span><br><span class="line">	.open		= hello_open,</span><br><span class="line">	.read		= hello_read,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>fuse_operations</code>结构体注释翻译</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fuse_operations</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> (*getattr) (<span class="type">const</span> <span class="type">char</span> *, <span class="keyword">struct</span> stat *);</span><br><span class="line">    <span class="comment">/* 这个函数与 stat() 类似。st_dev 和 st_blksize 域都可以忽略。st_ino 域也会被忽略，除非在执行 mount 时指定了 use_ino 选项 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*readlink) (<span class="type">const</span> <span class="type">char</span> *, <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">    <span class="comment">/* 这个函数会读取一个符号链接的目标。缓冲区应该是一个以 null 结束的字符串。缓冲区的大小参数包括这个 null 结束字符的空间。如果链接名太长，不能保存到缓冲区中，就应该被截断。成功时的返回值应该是 “0” */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*getdir) (<span class="type">const</span> <span class="type">char</span> *, <span class="type">fuse_dirh_t</span>, <span class="type">fuse_dirfil_t</span>);</span><br><span class="line">    <span class="comment">/* 这个函数会读取一个目录中的内容。这个操作实际上是在一次调用中执行 opendir()、readdir()、...、closedir() 序列。对于每个目录项来说，都应该调用 filldir() 函数 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*mknod) (<span class="type">const</span> <span class="type">char</span> *, <span class="type">mode_t</span>, <span class="type">dev_t</span>);</span><br><span class="line">    <span class="comment">/* 这个函数会创建一个文件节点。此处没有 create() 操作；mknod() 会在创建非目录、非符号链接的节点时调用 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*mkdir) (<span class="type">const</span> <span class="type">char</span> *, <span class="type">mode_t</span>);</span><br><span class="line">    <span class="type">int</span> (*rmdir) (<span class="type">const</span> <span class="type">char</span> *);</span><br><span class="line">    <span class="comment">/* 这两个函数分别用来创建和删除一个目录 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*unlink) (<span class="type">const</span> <span class="type">char</span> *);</span><br><span class="line">    <span class="type">int</span> (*rename) (<span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *);</span><br><span class="line">    <span class="comment">/* 这两个函数分别用来删除和重命名一个文件 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*symlink) (<span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *);</span><br><span class="line">    <span class="comment">/* 这个函数用来创建一个符号链接 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*link) (<span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *);</span><br><span class="line">    <span class="comment">/* 这个函数创建一个到文件的硬链接 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*chmod) (<span class="type">const</span> <span class="type">char</span> *, <span class="type">mode_t</span>);</span><br><span class="line">    <span class="type">int</span> (*chown) (<span class="type">const</span> <span class="type">char</span> *, <span class="type">uid_t</span>, <span class="type">gid_t</span>);</span><br><span class="line">    <span class="type">int</span> (*truncate) (<span class="type">const</span> <span class="type">char</span> *, <span class="type">off_t</span>);</span><br><span class="line">    <span class="type">int</span> (*utime) (<span class="type">const</span> <span class="type">char</span> *, <span class="keyword">struct</span> utimbuf *);</span><br><span class="line">    <span class="comment">/* 这 4 个函数分别用来修改文件的权限位、属主和用户、大小以及文件的访问/修改时间 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*open) (<span class="type">const</span> <span class="type">char</span> *, <span class="keyword">struct</span> fuse_file_info *);</span><br><span class="line">    <span class="comment">/* 这是文件的打开操作。对 open() 函数不能传递创建或截断标记（O_CREAT、O_EXCL、O_TRUNC）。这个函数应该检查是否允许执行给定的标记的操作。另外，open() 也可能在 fuse_file_info 结构中返回任意的文件句柄，这会传递给所有的文件操作 */</span></span><br><span class="line">    <span class="type">int</span> (*read) (<span class="type">const</span> <span class="type">char</span> *, <span class="type">char</span> *, <span class="type">size_t</span>, <span class="type">off_t</span>, <span class="keyword">struct</span> fuse_file_info *);</span><br><span class="line">    <span class="comment">/* 这个函数从一个打开文件中读取数据。除非碰到 EOF 或出现错误，否则 read() 应该返回所请求的字节数的数据；否则，其余数据都会被替换成 0。一个例外是在执行 mount 命令时指定了 direct_io 选项，在这种情况中 read() 系统调用的返回值会影响这个操作的返回值 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*write) (<span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *, <span class="type">size_t</span>, <span class="type">off_t</span>,<span class="keyword">struct</span> fuse_file_info *);</span><br><span class="line">    <span class="comment">/* 这个函数将数据写入一个打开的文件中。除非碰到 EOF 或出现错误，否则 write() 应该返回所请求的字节数的数据。一个例外是在执行 mount 命令时指定了 direct_io 选项（这于 read() 操作的情况类似） */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*statfs) (<span class="type">const</span> <span class="type">char</span> *, <span class="keyword">struct</span> statfs *);</span><br><span class="line">    <span class="comment">/* 这个函数获取文件系统的统计信息。f_type 和 f_fsid 域都会被忽略 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*flush) (<span class="type">const</span> <span class="type">char</span> *, <span class="keyword">struct</span> fuse_file_info *);</span><br><span class="line">    <span class="comment">/* 这表示要刷新缓存数据。它并不等于 fsync() 函数 —— 也不是请求同步脏数据。每次对一个文件描述符执行 close() 函数时，都会调用 flush()；因此如果文件系统希望在 close() 中返回写错误，并且这个文件已经缓存了脏数据，那么此处就是回写数据并返回错误的好地方。由于很多应用程序都会忽略 close() 错误，因此这通常用处不大 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*release) (<span class="type">const</span> <span class="type">char</span> *, <span class="keyword">struct</span> fuse_file_info *);</span><br><span class="line">    <span class="comment">/* 这个函数释放一个打开文件。release() 是在对一个打开文件没有其他引用时调用的 —— 此时所有的文件描述符都会被关闭，所有的内存映射都会被取消。对于每个 open() 调用来说，都必须有一个使用完全相同标记和文件描述符的 release() 调用。对一个文件打开多次是可能的，在这种情况中只会考虑最后一次 release，然后就不能再对这个文件执行更多的读/写操作了。release 的返回值会被忽略 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*fsync) (<span class="type">const</span> <span class="type">char</span> *, <span class="type">int</span>, <span class="keyword">struct</span> fuse_file_info *);</span><br><span class="line">    <span class="comment">/* 这个函数用来同步文件内容。如果 datasync 参数为非 0，那么就只会刷新用户数据，而不会刷新元数据 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*setxattr) (<span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *, <span class="type">size_t</span>, <span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*getxattr) (<span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *, <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">    <span class="type">int</span> (*listxattr) (<span class="type">const</span> <span class="type">char</span> *, <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">    <span class="type">int</span> (*removexattr) (<span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *);</span><br><span class="line">    <span class="comment">/* 这些函数分别用来设置、获取、列出和删除扩展属性 */</span></span><br><span class="line">    ......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E9%9A%8F%E4%BE%BF%E7%9C%8B%E7%9C%8B/" rel="tag"># 随便看看</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/07/23/26-Linux%E5%86%85%E6%A0%B8%E2%80%94%E2%80%94loopback%E8%AE%BE%E5%A4%87/" rel="next" title="Linux内核——loopback驱动">
                <i class="fa fa-chevron-left"></i> Linux内核——loopback驱动
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/09/28/3.C-%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%E5%85%88%E6%8A%8A%E9%A1%B9%E7%9B%AE%E8%B7%91%E8%B5%B7%E6%9D%A5/" rel="prev" title="C++实战——先把项目跑起来">
                C++实战——先把项目跑起来 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/my_avatar.png"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/">
              
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#fuse%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-number">1.</span> <span class="nav-text">fuse文件系统</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%9F%BA%E4%BA%8Efuse%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-number">1.1.</span> <span class="nav-text">1. 基于fuse实现的文件系统</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-libfuse%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB"><span class="nav-number">1.2.</span> <span class="nav-text">2.libfuse代码阅读</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1%E8%AF%95%E7%9D%80%E8%BF%90%E8%A1%8Chello%E8%BF%99%E4%B8%AA%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1试着运行hello这个最简单的文件系统</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AF%94%E5%A6%82"><span class="nav-number">1.3.</span> <span class="nav-text">比如</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2hello%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.3.1.</span> <span class="nav-text">2.2hello文件系统的实现</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dawnlake</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
